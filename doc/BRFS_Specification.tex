\documentclass[]{article}
\usepackage[a4paper,margin=1in]{geometry}
\usepackage{fancyhdr}
\usepackage{vhistory}
\usepackage{tabto}
\usepackage{tabularx}

\pagestyle{fancy}

%title page
\lhead{Working Draft}
\rhead{Revision 0.3}

\title{
	\textbf{BRFS Specification} \\
	\large Bruno Filesystem (formerly BOOT-ROOT)
}
\author{
	Angel Ruiz Fernandez \textless arf20\textgreater \\
	Bruno Castro Garc√≠a  \textless bruneo32\textgreater
}

\setcounter{tocdepth}{4}
\setcounter{secnumdepth}{4}


\begin{document}

	\maketitle
	\thispagestyle{fancy}
	
	\begin{abstract}
		This specification document describes the BRFS filesystem structure used to store data on storage devices. This provides a standard common description of the filesystem for developers to implement freely.
	\end{abstract}

	\begin{versionhistory}
		\vhEntry{0.1}{}{bruneo32}{Created}
		\vhEntry{0.2}{}{bruneo32}{Unknown}
		\vhEntry{0.3}{}{bruneo32, arf20}{This document}
	\end{versionhistory}

	\pagebreak
	
	\tableofcontents
	\pagebreak
	
	\section{Introduction}
	\subsection{Scope}
	
	This document defines the Bruno Filesystem. As a filesystem it provides a way of structuring data in a block-based (i.e. LBA) storage device. It is meant for embedded systems where a ciomplex filesystem is not needed, this is not a replacement for any modern desktop filesystem such as ext4, because it lacks basic features of journaling. Although BRFS is able to address large volumes, it is not recommended.
	
	\subsection{Definitions}
	
	Key words will be refferred to with a \texttt{monospace font}.
	
	\begin{itemize}
		\item block: Minimum filesystem unit of data
		\item unspecified: May be implementation dependent
	\end{itemize}
	
	\subsection{Advantages and disadvantages}
	
	\begin{tabularx}{\textwidth}{X|X}
		\textbf{Advantages} & \textbf{Disadvantages} \\
		\hline
		TODO when defined
	\end{tabularx}

	\subsection{Volume layout}

	\begin{tabular}{|l|} 
		\hline
		Superblock \\ 
		\hline	
		Root directory \\
		\hline
		\textless other files\textgreater \\
		\hline
		Free space \\
		\hline
	\end{tabular}

	\section{Superblock}
	
	The superblock records properties of the enclosed filesystem, such as the block size, pointer size and atribute size. It is 1 block in size. The remaining block will be padded with zeroes.
	
	\subsection{Superblock layout}
	
	\begin{tabular}{|l|l|l|} 
		\hline
		\textbf{Size (bytes)} & \textbf{Field (Unsigned integer)} & \textbf{Value} \\ [0.5ex] 
		\hline
		4 & Magic number & "BRFS" 0x42524653  \\ 
		\hline
		1 & Block size in LBAs & 0-255 (+1) \\
		\hline
		1 & Pointer size in bytes & 2, 4, or 8 \\
		\hline
		Pointer & Available space (RENAME) & \\
		\hline
		Pointer & First free block & \\
		\hline
		b-6 & Padding... & 0x00 \\
		\hline	
	\end{tabular}

	\subsection{Theorical limits}
	
	\begin{tabular}{|l|l|} 
		\hline
		\textbf{Property} & \textbf{Limit} \\ [0.5ex] 
		\hline
		Block size & 256 \\ 
		\hline
		Pointer size & 64 \\
		\hline
		Attribute size & 256 \\
		\hline
		Addresseable blocks & $2^{64}$ \\
		\hline	
		Addresseable LBAs & $256 \cdot 2^{64}$ \\
		\hline
		Absolute maxium capacity (512-byte LBA) & $512 \cdot 256 \cdot 2^{64} \approx $ 2 YiB \\
		\hline
	\end{tabular}\\

	The maximum capacity of the filesystem is calculated as follows
	\begin{equation}
		C = L \cdot B \cdot 2^p
	\end{equation}
	Where $p$ is pointer size, $B$ is block size and $L$ is LBA size.
	
	Some examples of reasonable configurations (assuming 512-byte LBA) are $p = 32$, $B = 8$, which gives 16 TiB capacity; or for more efficient storage, $p = 64$, $B = 1$: 8 ZiB; for embedded systems perhaps only a $p = 16$ $B = 1$ is needed, for 32 MiB.

	\section{File}
	
	BRFS is a file based filesystem. Regular files and directories are both files. 
	
	\begin{tabular}{|l|} 
		\hline
		Data \\
		\hline
		[Padding] \\
		\hline
		Next block pointer \\
		\hline
	\end{tabular}

	\subsection{Next block pointer}
	In the end of each file's block, lies a pointer to the next block of the file. This pointer is a linear offset of blocks.
	
	Pointer number 0 is reserved to denote EOF, and pointer 1 refers to next block. Pointer space starts with 2, the block after the first block of the root directory, which coincides with the global block offset.
	
	\begin{tabular}{|l|l|} 
		\hline
		 & \textbf{Block} \\ [0.5ex] 
		\hline
		0 & Superblock \\
		\hline
		1 & Root directory \\
		\hline
		2 & First file \\
		\hline
		3 & ... \\
		\hline
	\end{tabular}

	\subsection{Directory}
	
	A directory is a special file that holds file entries. There is no limit on the number of entries.
	
	\begin{tabular}{|l|} 
		\hline
		file0 \\ 
		\hline
		... \\
		\hline
		filen \\
		\hline
		[Padding] \\
		\hline
		Next block pointer \\
		\hline
	\end{tabular}

	\subsubsection{Directory entry}
	Describes file entry on directory

	\begin{tabular}{|l|l|} 
		\hline
		\textbf{Type (Size)} & \textbf{Field} \\ [0.5ex] 
		\hline
		8 & file size \\
		\hline
		22 & Attributes \\
		\hline
		Pointer & First block \\
		\hline
		unspecified & Filename (c-string) \\
		\hline
	\end{tabular}

	\subsubsection{Attributes}
	Following the POSIX.1-2017 standard, and inspired in some linux ext4 attributes. It takes 22 bytes.
	
	\begin{tabular}{|l|l|} 
		\hline
		\textbf{Value} & \textbf{Name} \\ [0.5ex] 
		\hline
		uint16 & mode \\
		\hline
		uint32 & uid \\
		\hline
		unit32 & gid \\
		\hline
		uint32 & crtime \\
		\hline
		uint32 & atime \\
		\hline
		uint32 & mtime \\
		\hline
	\end{tabular}

\end{document}
